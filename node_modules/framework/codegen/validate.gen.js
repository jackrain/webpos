/***************************************************
 * 名称：Webpos2.0代码生成工具
 * 日期：2014-12-15
 * 描述：主要用于生成Validator配置等文件
 * 作者：Beven
 **************************************************/
var IOUtil = require('fs-extra');
var PathUtil = require('path');
var StrUtil = require('../lib/string.js');
var GenUtil = require('./gen.util.js');
var ModelValidateGener = function () { }

//验证配置代码生成
ModelValidateGener.prototype.CodeGen = function (context) {
    console.log("start gen validate " + context.TableName);
    var path = PathUtil.join(__dirname, 'templates', 'validate.template');
    var template = GenUtil.ReadTemplate(path);
    var builder = [];
    var fields = context.Columns || [];
    var field = null;
    for (var i = 0, k = fields.length; i < k; i++) {
        field = fields[i];
        this.GenCfg(field, builder);
    }
    //保存文件
    var savePath = PathUtil.join(context.BaseDIR, "validates", context.TableName + ".validate.js");
    template = StrUtil.Format(template, context.TableName, context.Version, builder.join(',\r\n'));
    GenUtil.SaveFile(savePath, template);
    console.log("gened validate " + context.TableName);
}
//生成指定字段的验证配置
ModelValidateGener.prototype.GenCfg = function (field, builder) {
    var inner = [];
    inner.push('    ' + field.name + ': {');
    var rules = [];
    if (field.notnull == 1) {
        rules.push('        required: { InvalidMessage: \'必须填写\' }');
    }
    if (rules.length > 0) {
        inner.push(rules.join(',\r\n'));
    }
    inner.push('    }');
    builder.push(inner.join('\r\n'));
}

module.exports = new ModelValidateGener();