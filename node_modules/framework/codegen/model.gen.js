/***************************************************
 * 名称：Webpos2.0代码生成工具
 * 日期：2014-12-15
 * 描述：生成对应表的Model.js
 * 作者：Beven
 **************************************************/
var IOUtil = require('fs-extra');
var PathUtil = require('path');
var StrUtil = require('../lib/string.js');
var GenUtil = require('./gen.util.js');

var ModelGener = function () { }

/*
 * 名称：代码生成 这里主要是生backbone实体类生成带有get与set的属性器
 * 参数(context)：代码生成上下文
 */
ModelGener.prototype.CodeGen = function (context) {
    console.log("start gen model " + context.TableName);
    var path = PathUtil.join(__dirname, 'templates', 'model.template');
    var template = GenUtil.ReadTemplate(path);
    var builder = [];
    var fields = context.Columns || [];
    var field = null;
    builder.push(StrUtil.Format('__ClassName: \'{0}\'', context.TableName));
    for (var i = 0, k = fields.length; i < k; i++) {
        field = fields[i];
        this.GenGetter(field, builder);
        this.GenSetter(field, builder);
    }
    //保存文件
    var savePath = PathUtil.join(context.BaseDIR, "models", context.TableName + ".model.js");
    template = StrUtil.Format(template, context.TableName, context.Version, context.TableName, builder.join(',\r\n'));
    GenUtil.SaveFile(savePath, template);
    console.log("gened model " + context.TableName);
}
/*
 * 名称：生成getter访问器
 * 参数(field)：字段信息
 * 参数(builder)：代码存储数组
 */
ModelGener.prototype.GenGetter = function (field, builder) {
    var dv = field.dflt_value;
    if (dv != null && dv != '') {
        if (isNaN(dv)) { dv = "\'" + dv + "\'"; }
        builder.push(StrUtil.Format('    get{0}: function () { return this.get("{0}") || {1}; }', field.name, dv));
    } else {
        builder.push(StrUtil.Format('    get{0}: function () { return this.get("{0}"); }', field.name));
    }
}
/*
 * 名称：生成setter设置器
 * 参数(field)：字段信息
 * 参数(builder)：代码存储数组
 */
ModelGener.prototype.GenSetter = function (field, builder) {
    builder.push(StrUtil.Format('    set{0}: function (v,options) {  return this.set("{0}", v, options);  }', field.name));
}

module.exports = new ModelGener();
